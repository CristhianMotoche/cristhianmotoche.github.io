<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="description" content="A blog page for people who is interested in programming.">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>CAMM Blog</title>
    <link rel="icon" type="image/png" href="../images/devi.png">
    <link href="../assets/styles/app.css" rel="stylesheet">
    <meta name="google-site-verification" content="ZE7UdJw8EgIGYT1wlPQ1IDRaqOa9IseKmfw4ufHxEAk" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
  </head>
  <body class="body">
    <div class="body__container">
      <div class="logo">
        <h1 class="logo__title">
          <a class="logo__link" href="../">Camm Blog Page</a>
        </h1>
      </div>
      <nav class="navbar">
        <ul class="nav-list">
          <li class="nav-list__item">
            <a class="nav-list__link" href="../">Home</a>
          </li>
          <li class="nav-list__item">
            <a class="nav-list__link" href="../contact.html">About</a>
          </li>
          <li class="nav-list__item">
            <a class="nav-list__link" href="../archive.html">Archive</a>
          </li>
        </ul>
      </nav>
      <div class="content">
        <h1 class="content__title">Steps to create a new post. What a bummer!</h1>
        <div class="content_body">
          <link href="../css/hk-pyg.css" rel="stylesheet">
<link href="../css/tables.css" rel="stylesheet">
<div class="info">
    Posted on June 28, 2019
    
</div>
<div class="info">
    
    Tags: <a title="All pages tagged 'en'." href="../tags/en.html" rel="tag">en</a>, <a title="All pages tagged 'haskell'." href="../tags/haskell.html" rel="tag">haskell</a>
    
</div>

<p>Currently, this is the process I follow to create a new post:</p>
<p><img src="../images/create-new-blog/create-new-blog.gif" alt="drawing" width="1000" /></p>
<p>Yeah, I know, the dates are wrong and I just fixed that, but that’s not the worst part.
The worst part is that I have to do this each time I want to create a new post.
That’s a bummer! I must automate this!</p>
<p>I’m using <a href="https://hackage.haskell.org/package/hakyll">hakyll</a> to generate static pages for this blog post.
This tool provides a <a href="https://hackage.haskell.org/package/hakyll-4.12.5.2/docs/Hakyll-Main.html">set of functions</a> to run the hakyll compiler.
The <code>hakyll</code> function takes a set of rules and it’s ready to go:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> hakyll rules</span></code></pre></div>
<p>However, <code>hakyll</code> provides a CLI with a predefined set of commands:</p>
<pre><code>$ stack exec site

Missing: COMMAND

Usage: site [-v|--verbose] COMMAND
  site - Static site compiler created with Hakyll

Available options:
  -h,--help                Show this help text
  -v,--verbose             Run in verbose mode

Available commands:
  build                    Generate the site
  check                    Validate the site output
  clean                    Clean up and remove cache
  deploy                   Upload/deploy your site
  preview                  [DEPRECATED] Please use the watch command
  rebuild                  Clean and build again
  server                   Start a preview server
  watch                    Autocompile on changes and start a preview server.
                           You can watch and recompile without running a server</code></pre>
<p>All of those commands are useful, but I’d love to extend the commands with a new
one that starts a new post, something like:</p>
<pre><code>$ stack exec site new-post 'Post name'
POST GENERATED: posts/2019-05-28-Post-name.md</code></pre>
<p>And that’s the goal of this post!</p>
<h1 id="approach-1">Approach #1</h1>
<p>My first approach was to extend the commands from <code>hakyll</code>, but it seems it’s
not currently possible. So, I decided to try <a href="https://hackage.haskell.org/package/optparse-applicative">optparse-applicative</a>
and create a command line interface (CLI) on my own. However, I would have had
to rewrite a lot of code for the <code>hakyll</code> commands. So, I decided to add a
new command and then use the rest of <code>hakyll</code> commands:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Opts</span> <span class="ot">=</span> <span class="dt">New</span> <span class="dt">String</span> <span class="kw">deriving</span> <span class="dt">Show</span></span></code></pre></div>
<p>Now, let’s define a <code>Parser</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">parser ::</span> <span class="dt">Parser</span> <span class="dt">Opts</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>parser <span class="ot">=</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">New</span> <span class="op">&lt;$&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    subparser</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      (command <span class="st">&quot;new&quot;</span> (info (option str (long <span class="st">&quot;name&quot;</span>)) (progDesc <span class="st">&quot;New post&quot;</span>)))</span></code></pre></div>
<p>Unfortunately, <code>execParser</code> or <code>customExecParser</code> from
<code>optparse-applicative</code> use <a href="https://hackage.haskell.org/package/optparse-applicative-0.14.3.0/docs/src/Options.Applicative.Extra.html#handleParseResult"><code>handleParseResult</code></a>
that exits when the command is not in parsed. I don’t want to exit
on failure, because on failure I want to attempt <code>hakyll</code> commands. Fortunately,
<code>optparse-applicative</code> provides <a href="https://hackage.haskell.org/package/optparse-applicative-0.14.3.0/docs/Options-Applicative.html#v:execParserPure"><code>execParsePure</code></a> that allows me
to handle the parser result as I want. In this case, I attempted this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  args <span class="ot">&lt;-</span> getArgs</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> parseResult <span class="ot">=</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        execParserPure</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>          (prefs showHelpOnError)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>          (info (helper <span class="op">&lt;*&gt;</span> parser) fullDesc)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>          args</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> parseResult <span class="kw">of</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Success</span> (<span class="dt">New</span> name) <span class="ot">-&gt;</span> mkNewPost name <span class="op">&gt;&gt;=</span> createNewPost</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Failure</span> failure    <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      progname <span class="ot">&lt;-</span> getProgName</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> (msg, _) <span class="ot">=</span> renderFailure failure progname</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">putStrLn</span> <span class="st">&quot;# CUSTOM COMMANDS&quot;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      hPutStrLn stderr msg</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">putStrLn</span> <span class="st">&quot;\n# HAKYLL COMMANDS&quot;</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      hakyll rules</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    completionInvoke   <span class="ot">-&gt;</span> void <span class="op">$</span> handleParseResult completionInvoke</span></code></pre></div>
<p><code>execParserPure</code> returns a <code>ParserResult</code> and I simply pattern matched it.
If the parsing is successful and parses <code>New name</code> it creates a new post and
creates a basic templace with the current date and a given <code>name</code>.
If it fails, it renders the parsing failure, prints some messages to separate the
results from my custom commands and the ones from <code>hakyll</code>,
redirects the parsing error to <code>stderr</code>, and then executes any <code>hakyll</code> command.
Finally, if the parser result is <code>Completition</code>, I delegate <code>handleParseResult</code>
to take care of that, because I don’t know what to do with that.</p>
<p>Now the results:</p>
<pre><code>$ stack exec site

# CUSTOM COMMANDS
Missing: COMMAND

Usage: site COMMAND

Available options:
  -h,--help                Show this help text

Available commands:
  new                      New post

# HAKYLL COMMANDS
Missing: COMMAND

Usage: site [-v|--verbose] COMMAND
  site - Static site compiler created with Hakyll

Available options:
  -h,--help                Show this help text
  -v,--verbose             Run in verbose mode

Available commands:
  build                    Generate the site
  check                    Validate the site output
  ...</code></pre>
<p>Nice! Now, I can do this:</p>
<pre><code>$ stack exec site new --name &quot;some post&quot;
$ ls posts/
...
2019-06-06-some-post.md</code></pre>
<p>And if you want to execute the <code>hakyll</code> commands:</p>
<pre><code>$ stack exec site watch
CUSTOM COMMANDS
Invalid argument `watch'

Usage: site COMMAND

Available options:
  -h,--help                Show this help text

Available commands:
  new                      New post

HAKYLL COMMANDS
Listening on http://127.0.0.1:8000
Initialising...
  Creating store...
  Creating provider...
  Running rules...
Checking for out-of-date items
Compiling
Success</code></pre>
<p>You are probably thinking: Pfff! That’s gonna print the failure of your parser dummy! That’s terrible -_-</p>
<p>I’m probably going to say: Definatelly, I agree with you. I’m going to look for a better approach
but for now that will work.</p>
<p>Thanks for reading.</p>
<p>ByE!</p>

<div id="disqus_thread"></div>
<script>
/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
 */
/*
   var disqus_config = function () {
   this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
   this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
   };
 */
(function() {  // DON'T EDIT BELOW THIS LINE
 var d = document, s = d.createElement('script');

 s.src = '//cristhianmotochegithubio.disqus.com/embed.js';

 s.setAttribute('data-timestamp', +new Date());
 (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </div>
      </div>
      <footer class="footer">
        <p class="footer__hakyll">Site proudly generated by: <a href="http://jaspervdj.be/hakyll">Hakyll</a></p>
        <a class="footer__license" rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">CAMM Blog</span> by <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName">Cristhian Alberto Motoche Macas</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
      </footer>
    </div>
    <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-86039843-1', 'auto');
    ga('send', 'pageview');
    </script>
  </body>
</html>
